(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[702],{3735:function(t,e,n){Promise.resolve().then(n.bind(n,4591))},4591:function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return f}});var r=n(7437),i=n(2471),a=n(5694),s=n(7138),o=n(2265),u=n(6463),l=n(4078),d=n(3947);let c=[{title:"今天",order:1},{title:"本周",order:2},{title:"稍后",order:3}];function f(){let t=(0,i.x)(),e=(0,u.useRouter)(),n=(0,d.t)(t=>t.token),f=(0,d.t)(t=>t.setToken),m=(0,d.t)(t=>t.clearAuth),[p,h]=(0,o.useState)(!0),[v,b]=(0,o.useState)(null),[x,g]=(0,o.useState)(null),[w,y]=(0,o.useState)([]),[k,I]=(0,o.useState)({}),N=(0,o.useRef)({}),[j]=(0,a.D)(l.V_),[_]=(0,a.D)(l.Bv),[$,{loading:C}]=(0,a.D)(l.ew),P=(0,o.useMemo)(()=>[...w].sort((t,e)=>t.order-e.order),[w]);(0,o.useEffect)(()=>{if(!n){let t=localStorage.getItem("taskboard_token");t?f(t):e.replace("/login")}},[e,f,n]);let S=t=>{var n,r,i;return"UNAUTHENTICATED"===(null==t?void 0:null===(i=t.graphQLErrors)||void 0===i?void 0:null===(r=i[0])||void 0===r?void 0:null===(n=r.extensions)||void 0===n?void 0:n.code)&&(m(),e.replace("/login"),!0)};(0,o.useEffect)(()=>{n&&(async()=>{h(!0),b(null);try{let r,i;try{r=await t.query({query:l.mL,fetchPolicy:"network-only"})}catch(t){if(S(t))return;throw t}if(r.data.boards.length)i=r.data.boards[0].id;else{var e,n;let t=await j({variables:{input:{title:"My Board",visibility:"PRIVATE"}}});i=null===(n=t.data)||void 0===n?void 0:null===(e=n.createBoard)||void 0===e?void 0:e.id}if(!i)throw Error("Failed to get or create board");g(i);let a=async()=>t.query({query:l.sY,variables:{boardId:i},fetchPolicy:"network-only"}),s=await a(),o=new Set(s.data.lists.map(t=>t.title)),u=c.filter(t=>!o.has(t.title));for(let t of u)await _({variables:{input:{boardId:i,title:t.title,order:t.order}}});u.length&&(s=await a());let d=[];for(let e of s.data.lists)try{let n=await t.query({query:l.XB,variables:{listId:e.id},fetchPolicy:"network-only"});d.push({id:e.id,title:e.title,order:e.order,tasksCount:n.data.tasks.length})}catch(t){if(S(t))return;throw t}y(d)}catch(t){S(t)||b(t.message||"Failed to load dashboard")}finally{h(!1)}})()},[t,j,_,n,e,m]);let E=async t=>{let e=(k[t]||"").trim();if(e)try{var n;let r=await $({variables:{input:{listId:t,title:e}}});(null===(n=r.data)||void 0===n?void 0:n.createTask)&&(y(e=>e.map(e=>e.id===t?{...e,tasksCount:e.tasksCount+1}:e)),I(e=>({...e,[t]:""})))}catch(t){S(t),b(t.message||"Failed to create task")}},T=t=>{let e=N.current[t];e&&e.focus()};return(0,r.jsx)("main",{className:"w-full min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 px-6 py-10",children:(0,r.jsxs)("div",{className:"mx-auto flex w-full max-w-6xl flex-col gap-6",children:[(0,r.jsxs)("header",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-xs uppercase tracking-[0.35em] text-amber-300",children:"Dashboard"}),(0,r.jsx)("h1",{className:"text-3xl font-semibold text-white",children:"我的taskboard面板"}),x&&(0,r.jsxs)("p",{className:"text-xs text-slate-400",children:["默认看板 ID: ",x]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3 text-sm",children:[(0,r.jsx)(s.default,{href:"/boards",className:"text-amber-300 hover:text-amber-200",children:"Go to Boards"}),(0,r.jsx)(s.default,{href:"/profile",className:"text-amber-300 hover:text-amber-200",children:"Profile"})]})]}),p&&(0,r.jsx)("p",{className:"text-sm text-slate-300",children:"Loading dashboard..."}),v&&(0,r.jsx)("p",{className:"text-sm text-red-300",children:v}),(0,r.jsx)("div",{className:"grid gap-4 md:grid-cols-3",children:P.map(t=>{var e;return(0,r.jsxs)("div",{className:"rounded-2xl border border-white/10 bg-white/5 p-4 shadow-lg backdrop-blur",children:[(0,r.jsxs)("div",{className:"mb-3 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>T(t.id),className:"flex h-8 w-8 items-center justify-center rounded-full border border-amber-300 text-amber-200 hover:bg-amber-500 hover:text-slate-900",title:"Add task",children:"+"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-lg font-semibold text-white",children:t.title}),(0,r.jsxs)("p",{className:"text-xs text-slate-400",children:[t.tasksCount," tasks"]})]})]}),(0,r.jsx)("button",{className:"rounded-full px-2 py-1 text-xs text-slate-300 hover:bg-white/10",title:"More",children:"..."})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("input",{ref:e=>N.current[t.id]=e,value:null!==(e=k[t.id])&&void 0!==e?e:"",onChange:e=>I(n=>({...n,[t.id]:e.target.value})),placeholder:"Quick task title",className:"w-full rounded-xl border border-white/10 bg-slate-800/60 px-3 py-2 text-sm text-white focus:border-amber-400 focus:outline-none"}),(0,r.jsx)("button",{onClick:()=>E(t.id),disabled:C,className:"w-full rounded-xl bg-amber-500 px-3 py-2 text-sm font-semibold text-slate-900 shadow hover:bg-amber-400 disabled:opacity-60",children:C?"Creating...":"Add Task"})]})]},t.id)})})]})})}},4078:function(t,e,n){"use strict";n.d(e,{$E:function(){return C},Bv:function(){return j},Jn:function(){return y},Nz:function(){return g},V_:function(){return N},XB:function(){return I},Z8:function(){return $},ew:function(){return _},mL:function(){return w},sY:function(){return k},ym:function(){return x}});var r=n(8646),i=n(1432);function a(){let t=(0,r._)(["\n  mutation Login($input: LoginInput!) {\n    login(input: $input) {\n      token\n      user {\n        id\n        email\n        name\n        role\n        status\n      }\n    }\n  }\n"]);return a=function(){return t},t}function s(){let t=(0,r._)(["\n  mutation Register($input: RegisterInput!) {\n    register(input: $input) {\n      token\n      user {\n        id\n        email\n        name\n        role\n        status\n      }\n    }\n  }\n"]);return s=function(){return t},t}function o(){let t=(0,r._)(["\n  query Me {\n    me {\n      id\n      email\n      name\n      role\n      status\n    }\n  }\n"]);return o=function(){return t},t}function u(){let t=(0,r._)(["\n  query Boards {\n    boards {\n      id\n      title\n      visibility\n    }\n  }\n"]);return u=function(){return t},t}function l(){let t=(0,r._)(["\n  query Board($id: ID!) {\n    board(id: $id) {\n      id\n      title\n      visibility\n      ownerId\n    }\n  }\n"]);return l=function(){return t},t}function d(){let t=(0,r._)(["\n  query Lists($boardId: ID!) {\n    lists(boardId: $boardId) {\n      id\n      title\n      order\n      color\n    }\n  }\n"]);return d=function(){return t},t}function c(){let t=(0,r._)(["\n  query Tasks($listId: ID!) {\n    tasks(listId: $listId) {\n      id\n      listId\n      title\n      description\n      status\n      priority\n      tags\n    }\n  }\n"]);return c=function(){return t},t}function f(){let t=(0,r._)(["\n  query Task($id: ID!) {\n    task(id: $id) {\n      id\n      listId\n      title\n      description\n      status\n      priority\n      tags\n      assigneeId\n      dueDate\n    }\n  }\n"]);return f=function(){return t},t}function m(){let t=(0,r._)(["\n  mutation CreateBoard($input: CreateBoardInput!) {\n    createBoard(input: $input) {\n      id\n      title\n      visibility\n    }\n  }\n"]);return m=function(){return t},t}function p(){let t=(0,r._)(["\n  mutation CreateList($input: CreateListInput!) {\n    createList(input: $input) {\n      id\n      title\n      order\n      boardId\n    }\n  }\n"]);return p=function(){return t},t}function h(){let t=(0,r._)(["\n  mutation CreateTask($input: CreateTaskInput!) {\n    createTask(input: $input) {\n      id\n      title\n      listId\n      status\n      priority\n      tags\n    }\n  }\n"]);return h=function(){return t},t}function v(){let t=(0,r._)(["\n  mutation UpdateTaskStatus($id: ID!, $status: TaskStatus!) {\n    updateTaskStatus(id: $id, status: $status) {\n      id\n      title\n      listId\n      status\n      priority\n      tags\n    }\n  }\n"]);return v=function(){return t},t}function b(){let t=(0,r._)(["\n  subscription TaskUpdated($boardId: ID!) {\n    taskUpdated(boardId: $boardId) {\n      type\n      task {\n        id\n        listId\n        title\n        status\n        priority\n        tags\n      }\n    }\n  }\n"]);return b=function(){return t},t}let x=(0,i.Ps)(a()),g=(0,i.Ps)(s());(0,i.Ps)(o());let w=(0,i.Ps)(u()),y=(0,i.Ps)(l()),k=(0,i.Ps)(d()),I=(0,i.Ps)(c());(0,i.Ps)(f());let N=(0,i.Ps)(m()),j=(0,i.Ps)(p()),_=(0,i.Ps)(h()),$=(0,i.Ps)(v()),C=(0,i.Ps)(b())},6463:function(t,e,n){"use strict";var r=n(1169);n.o(r,"useParams")&&n.d(e,{useParams:function(){return r.useParams}}),n.o(r,"useRouter")&&n.d(e,{useRouter:function(){return r.useRouter}})},3947:function(t,e,n){"use strict";n.d(e,{t:function(){return s}});var r=n(9099);let i="taskboard_token",a="taskboard_user",s=(0,r.Ue)(t=>({token:null,user:null,hydrated:!1,setToken:e=>{e?window.localStorage.setItem(i,e):window.localStorage.removeItem(i),t({token:e})},setUser:e=>{e?window.localStorage.setItem(a,JSON.stringify(e)):window.localStorage.removeItem(a),t({user:e})},clearAuth:()=>{window.localStorage.removeItem(i),window.localStorage.removeItem(a),t({token:null,user:null})},hydrateFromStorage:()=>{let e=window.localStorage.getItem(i),n=window.localStorage.getItem(a);t({token:e||null,user:n?JSON.parse(n):null,hydrated:!0})}}))},9422:function(t,e,n){"use strict";n.d(e,{L:function(){return i}});var r=n(2474),i=n(2511).Nq?r.useLayoutEffect:r.useEffect},5694:function(t,e,n){"use strict";n.d(e,{D:function(){return f}});var r=n(1735),i=n(2474),a=n(1135),s=n(4511),o=n(8607),u=n(1288),l=n(2471),d=n(9422),c=n(4230);function f(t,e){!1!==globalThis.__DEV__&&(0,c.G)(e||{},"ignoreResults","useMutation","If you don't want to synchronize component state with the mutation, please use the `useApolloClient` hook to get the client instance and call `client.mutate` directly.");var n=(0,l.x)(null==e?void 0:e.client);(0,o.Vp)(t,o.n_.Mutation);var f=i.useState({called:!1,loading:!1,client:n}),m=f[0],p=f[1],h=i.useRef({result:m,mutationId:0,isMounted:!0,client:n,mutation:t,options:e});(0,d.L)(function(){Object.assign(h.current,{client:n,options:e,mutation:t})});var v=i.useCallback(function(t){void 0===t&&(t={});var e=h.current,n=e.options,i=e.mutation,o=(0,r.pi)((0,r.pi)({},n),{mutation:i}),l=t.client||h.current.client;h.current.result.loading||o.ignoreResults||!h.current.isMounted||p(h.current.result={loading:!0,error:void 0,data:void 0,called:!0,client:l});var d=++h.current.mutationId,c=(0,a.J)(o,t);return l.mutate(c).then(function(e){var n,r,i=e.data,a=e.errors,o=a&&a.length>0?new u.cA({graphQLErrors:a}):void 0,f=t.onError||(null===(n=h.current.options)||void 0===n?void 0:n.onError);if(o&&f&&f(o,c),d===h.current.mutationId&&!c.ignoreResults){var m={called:!0,loading:!1,data:i,error:o,client:l};h.current.isMounted&&!(0,s.D)(h.current.result,m)&&p(h.current.result=m)}var v=t.onCompleted||(null===(r=h.current.options)||void 0===r?void 0:r.onCompleted);return o||null==v||v(e.data,c),e},function(e){if(d===h.current.mutationId&&h.current.isMounted){var n,r={loading:!1,error:e,data:void 0,called:!0,client:l};(0,s.D)(h.current.result,r)||p(h.current.result=r)}var i=t.onError||(null===(n=h.current.options)||void 0===n?void 0:n.onError);if(i)return i(e,c),{data:void 0,errors:e};throw e})},[]),b=i.useCallback(function(){if(h.current.isMounted){var t={called:!1,loading:!1,client:h.current.client};Object.assign(h.current,{mutationId:0,result:t}),p(t)}},[]);return i.useEffect(function(){var t=h.current;return t.isMounted=!0,function(){t.isMounted=!1}},[]),[v,(0,r.pi)({reset:b},m)]}}},function(t){t.O(0,[22,506,971,23,744],function(){return t(t.s=3735)}),_N_E=t.O()}]);